# Session Context - 2025-12-29

> **Purpose**: Track context for this coding session.

---

## Session Summary

**Date**: 2025-12-29

**What Was Worked On**:
- Implemented complete Privy wallet integration for robots
- Added dual wallet support (user-provided + Privy-created)
- Added wallet switching functionality
- Added USDC transfer for collecting robot earnings
- Added ETH funding from user wallet for gas fees
- Added wallet balance endpoint (ETH + USDC)

**What Was Accomplished**:
- Full Privy wallet management system
- Robots can have either user-provided OR Privy-managed wallets
- Users can switch between wallet types
- USDC earnings collection via Privy wallet
- ETH price API for gas funding calculations
- All endpoints working and tested

**Where We Left Off**:
- Backend fully implemented and working
- Frontend integration complete (see frontend docs)
- USDC transfer tested successfully

---

## Implementation Details

### Database Changes

**New fields in Robot model** (`app/models/robot.py`):
```python
wallet_address: str              # Active wallet (current payment receiver)
wallet_source: WalletSource      # 'user_provided' or 'privy_created'
user_wallet_address: str | None  # Original user wallet (preserved)
privy_wallet_address: str | None # Privy-created wallet (preserved)
privy_wallet_id: str | None      # Privy wallet ID for signing transactions
owner_wallet: str | None         # Owner's address/ENS/Base name for payouts
deleted_at: datetime | None      # Soft delete timestamp
```

**Migration**: `alembic/versions/002_add_dual_wallet_fields.py`

### New API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/robots` | Register robot (creates Privy wallet if no address provided) |
| GET | `/api/v1/robots` | List all robots |
| GET | `/api/v1/robots/{id}` | Get robot details |
| PATCH | `/api/v1/robots/{id}` | Update robot (name, IPs, owner_wallet, wallet_address) |
| DELETE | `/api/v1/robots/{id}` | Soft delete robot |
| POST | `/api/v1/robots/{id}/sync-wallet` | Re-send wallet to hardware |
| POST | `/api/v1/robots/{id}/payout` | Transfer USDC to owner wallet |
| POST | `/api/v1/robots/{id}/switch-wallet` | Switch between user/Privy wallet |
| GET | `/api/v1/robots/{id}/balance` | Get ETH and USDC balances |
| GET | `/api/v1/robots/gas-funding-info` | Get ETH price for gas funding |

### Privy Service Methods

**File**: `app/services/privy.py`

```python
# Wallet management
create_wallet(chain_type="ethereum") -> PrivyWallet
get_wallet(wallet_id) -> PrivyWallet | None

# Transactions
send_transaction(wallet_id, to_address, amount_wei) -> str  # ETH transfer
send_usdc(wallet_id, to_address, amount) -> str             # USDC transfer

# Balance checking
get_balance(wallet_address) -> int          # ETH in wei
get_usdc_balance(wallet_address) -> int     # USDC in smallest units

# Price API
get_eth_price_usd() -> float
calculate_eth_for_usd(usd_amount, eth_price) -> int
```

### Key Design Decisions

1. **Dual wallet storage**: Both user and Privy wallets preserved in database
2. **Wallet switching**: Users can switch between wallet types without losing either
3. **Soft delete**: Robots are soft-deleted, can be reactivated with same wallet
4. **mDNS deduplication**: Robots identified by mDNS name to prevent duplicates
5. **USDC-only payout**: Collect earnings transfers USDC, not ETH
6. **Separate gas funding**: ETH for gas funded separately from user's wallet

### Environment Variables

```env
DATABASE_URL=sqlite+aiosqlite:///./robots.db
PRIVY_APP_ID=your-app-id
PRIVY_APP_SECRET=your-app-secret
```

---

## Problems Solved This Session

### 1. Privy API Chain ID Format (CAIP-2)

**Problem**: USDC transfer returning 400 Bad Request from Privy API

**Solution**: Use `caip2` format instead of `chainId` in transaction:
```python
# Before (wrong)
"chainId": chain_id,

# After (correct)
"caip2": f"eip155:{chain_id}",
```

### 2. ERC20 USDC Transfer Encoding

**Problem**: Need to transfer USDC (ERC20 token) via Privy wallet

**Solution**: Encode `transfer(address,uint256)` call manually:
```python
# Function selector: 0xa9059cbb
to_padded = to_address.lower().replace("0x", "").zfill(64)
amount_padded = hex(amount)[2:].zfill(64)
data_hex = f"0xa9059cbb{to_padded}{amount_padded}"
# Send to USDC contract address with encoded data
```

### 3. User Wallet Address Not Preserved on Update

**Problem**: When updating wallet_address for user-provided wallets, `user_wallet_address` wasn't updated

**Solution**: Added in `update_robot()`:
```python
if "wallet_address" in update_data:
    robot.user_wallet_address = update_data["wallet_address"]
```

### 4. Frontend Blank Page After Migration

**Problem**: Old localStorage data missing required `walletAddress` and `walletSource` fields

**Solution**: Updated store merge function to filter invalid robots and force re-sync from backend

---

## Files Changed

### New Files
- `app/core/database.py` - SQLAlchemy async engine + session
- `app/models/robot.py` - Robot model with wallet fields
- `app/schemas/robot.py` - Pydantic schemas for all endpoints
- `app/services/privy.py` - Privy API client
- `app/services/robot_wallet.py` - Robot CRUD + wallet management
- `app/api/v1/robots.py` - REST endpoints
- `alembic/` - Migration setup and versions

### Modified Files
- `app/main.py` - Added robots router
- `app/core/config.py` - Added Privy and database settings
- `pyproject.toml` - Added SQLAlchemy, Alembic, aiosqlite dependencies

---

## Commands Reference

```bash
# Run server
uv run uvicorn app.main:app --reload

# Run tests
uv run pytest -v

# Run linting
uv run ruff check . --fix

# Database migrations
uv run alembic upgrade head
uv run alembic revision --autogenerate -m "description"

# Test endpoints
curl http://localhost:8000/api/v1/robots
curl -X POST http://localhost:8000/api/v1/robots/{id}/payout
curl http://localhost:8000/api/v1/robots/{id}/balance
```

---

## To Continue This Work

The backend Privy wallet integration is complete. Next steps could be:
- Add tests for new endpoints
- Add rate limiting for Privy API calls
- Add webhook support for transaction notifications
- Production PostgreSQL migration
