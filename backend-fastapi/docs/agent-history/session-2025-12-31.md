# Session Context - 2025-12-31

> **Purpose**: Track context for this coding session.

---

## Session Summary

**Date**: 2025-12-31

**What Was Worked On**:
- Separate Docker deployment for backend and frontend
- Database migration path fix (Alembic)
- Daily rotating log files
- CORS preflight handling fix

**What Was Accomplished**:
- Created standalone Dockerfiles and docker-compose.yml for each service
- Created build/start/stop scripts with `_backend` and `_frontend` suffixes
- Added daily rotating log files to `/app/logs/`
- Fixed Alembic to use `DATABASE_URL` from environment variable
- Fixed CORS preflight (OPTIONS) handling in x402 middleware
- Fixed database path mismatch between Alembic and app
- Comprehensive `DEPLOYMENT_GUIDE.md` with multi-domain support
- Removed old root-level deployment files

**Where We Left Off**:
- Docker deployment working locally
- Backend runs with `./build_backend.sh && ./start_backend.sh`
- Frontend runs with `./build_frontend.sh && ./start_frontend.sh`
- Shared Docker network `yakrover_network` for container communication

---

## Implementation Details

### Separate Docker Deployment

**Backend Files**:
- `backend-fastapi/Dockerfile` - Python 3.11 + uv package manager
- `backend-fastapi/docker-compose.yml` - Backend orchestration
- `backend-fastapi/build_backend.sh` - Build image
- `backend-fastapi/start_backend.sh` - Start container
- `backend-fastapi/stop_backend.sh` - Stop container (with `--clean` option)

**Frontend Files**:
- `frontend-react/Dockerfile.standalone` - Node + Caddy for serving
- `frontend-react/docker-compose.yml` - Frontend orchestration with env vars
- `frontend-react/Caddyfile.standalone` - Caddy config with domain variables
- `frontend-react/build_frontend.sh` - Build image
- `frontend-react/start_frontend.sh` - Start container
- `frontend-react/stop_frontend.sh` - Stop container (with `--clean` option)

### Database Migration Fix

**Problem**: Alembic ran migrations against `./robots.db` but app used `./data/robots.db`.

**Solution**:
1. Updated `alembic.ini` to use `./data/robots.db`
2. Updated `alembic/env.py` to prefer `DATABASE_URL` environment variable:

```python
# Override sqlalchemy.url from environment variable if set
if os.environ.get("DATABASE_URL"):
    config.set_main_option("sqlalchemy.url", os.environ["DATABASE_URL"])
```

### Daily Rotating Logs

**Configuration** (`app/core/logging.py`):
```python
file_handler = TimedRotatingFileHandler(
    LOG_FILE,
    when="midnight",
    interval=1,
    backupCount=30,
    encoding="utf-8",
)
file_handler.suffix = "%Y-%m-%d"
```

**Files**:
- Current day: `yakrover.log`
- Past days: `yakrover.log.2025-12-31`

### CORS Preflight Fix

**Problem**: x402 middleware intercepted OPTIONS requests before checking the path.

**Solution** (`app/core/x402_dynamic.py`):
```python
async def dynamic_x402_middleware(request: Request, call_next) -> Response:
    # Skip OPTIONS (CORS preflight) for ALL endpoints - check FIRST
    if request.method == "OPTIONS":
        return await call_next(request)

    # Only intercept purchase endpoint
    if request.url.path != "/api/v1/access/purchase":
        return await call_next(request)
    # ...
```

---

## Problems Solved This Session

### 1. Alembic Migration Creates Tables in Wrong Database

**Symptoms**: `sqlite3.OperationalError: no such table: robots` after migration reports success.

**Root Cause**: `alembic.ini` had `sqlalchemy.url = sqlite+aiosqlite:///./robots.db` but `.env` had `DATABASE_URL=sqlite+aiosqlite:///./data/robots.db`.

**Solution**:
- Updated `alembic.ini` to use `./data/robots.db`
- Updated `alembic/env.py` to read from `DATABASE_URL` environment variable

### 2. CORS 400 Error on OPTIONS Requests

**Symptoms**: Frontend gets 400 errors on preflight requests.

**Root Cause**: `http://localhost` was missing from `CORS_ORIGINS` in `.env`.

**Solution**: Added `http://localhost` to CORS_ORIGINS.

### 3. x402 Middleware Blocking OPTIONS

**Symptoms**: CORS preflight failing with 402 or errors.

**Root Cause**: x402 middleware checked path before checking if request was OPTIONS.

**Solution**: Check for OPTIONS method first, before any other logic.

---

## Files Changed

### New Files
- `DEPLOYMENT_GUIDE.md`
- `backend-fastapi/Dockerfile`
- `backend-fastapi/docker-compose.yml`
- `backend-fastapi/build_backend.sh`
- `backend-fastapi/start_backend.sh`
- `backend-fastapi/stop_backend.sh`
- `backend-fastapi/app/core/logging.py`
- `frontend-react/Dockerfile.standalone`
- `frontend-react/docker-compose.yml`
- `frontend-react/Caddyfile.standalone`
- `frontend-react/build_frontend.sh`
- `frontend-react/start_frontend.sh`
- `frontend-react/stop_frontend.sh`

### Modified Files
- `backend-fastapi/alembic.ini` - Database path fix
- `backend-fastapi/alembic/env.py` - Read DATABASE_URL from env
- `backend-fastapi/app/core/x402_dynamic.py` - OPTIONS check first
- `backend-fastapi/app/main.py` - Logging integration, renamed to YakRover
- `backend-fastapi/.gitignore` - Ignore logs/
- `frontend-react/src/config/privy.ts` - SDK API change
- `frontend-react/src/providers/PrivyAuthProvider.tsx` - Config access fix
- `frontend-react/src/stores/robotStore.ts` - Null checks
- `frontend-react/src/stores/__tests__/robotStore.test.ts` - Type fix

### Deleted Files
- Root-level `build.sh`, `start.sh`, `stop.sh`
- Root-level `docker-compose.yml`

---

## Key Commands

```bash
# Create shared network (once)
docker network create yakrover_network

# Backend
cd backend-fastapi
./build_backend.sh
./start_backend.sh
./stop_backend.sh --clean  # Remove images/volumes

# Frontend
cd frontend-react
DOMAIN=yakrover.com ./build_frontend.sh
DOMAIN=yakrover.com ./start_frontend.sh
./stop_frontend.sh --clean

# View logs
docker compose logs -f
cat logs/yakrover.log
```

---

## To Continue This Work

- Push to remote and deploy to DigitalOcean
- Test with actual domain (yakrover.com/net/org)
- Add TLS certificates (Caddy handles automatically)
- Monitor logs for issues
